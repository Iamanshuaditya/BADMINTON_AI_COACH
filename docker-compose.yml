# =============================================================================
# ShuttleSense Docker Compose Configuration
# Development and Production setup
# =============================================================================

version: '3.9'

services:
  # ===========================================================================
  # Backend API Service
  # ===========================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: shuttlesense-backend
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      # Application
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DEBUG=${DEBUG:-true}
      
      # Security
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-CHANGE_ME_IN_PRODUCTION}
      
      # External APIs
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      
      # CORS (allow frontend)
      - CORS_ORIGINS=http://localhost:3000,http://localhost:80,http://frontend:80
      
      # Rate Limiting
      - RATE_LIMIT_ENABLED=${RATE_LIMIT_ENABLED:-true}
      
      # Paths
      - UPLOAD_DIR=/app/data/uploads
      - SESSIONS_DIR=/app/data/sessions
    volumes:
      # Persist data
      - backend_uploads:/app/data/uploads
      - backend_sessions:/app/data/sessions
      # Development: mount source for hot reload
      # - ./backend:/app
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - shuttlesense-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G

  # ===========================================================================
  # Frontend Web Service
  # ===========================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: shuttlesense-frontend
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - shuttlesense-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

  # ===========================================================================
  # Redis (for rate limiting and caching - optional)
  # ===========================================================================
  # redis:
  #   image: redis:7-alpine
  #   container_name: shuttlesense-redis
  #   restart: unless-stopped
  #   ports:
  #     - "6379:6379"
  #   volumes:
  #     - redis_data:/data
  #   command: redis-server --appendonly yes
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "ping"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   networks:
  #     - shuttlesense-network

  # ===========================================================================
  # PostgreSQL (for production data storage - optional)
  # ===========================================================================
  # db:
  #   image: postgres:16-alpine
  #   container_name: shuttlesense-db
  #   restart: unless-stopped
  #   environment:
  #     - POSTGRES_USER=${DB_USER:-shuttlesense}
  #     - POSTGRES_PASSWORD=${DB_PASSWORD:-changeme}
  #     - POSTGRES_DB=${DB_NAME:-shuttlesense}
  #   ports:
  #     - "5432:5432"
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U shuttlesense"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   networks:
  #     - shuttlesense-network

# =============================================================================
# Networks
# =============================================================================
networks:
  shuttlesense-network:
    driver: bridge

# =============================================================================
# Volumes
# =============================================================================
volumes:
  backend_uploads:
    driver: local
  backend_sessions:
    driver: local
  # redis_data:
  #   driver: local
  # postgres_data:
  #   driver: local
